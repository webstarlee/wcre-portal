<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <title>Admin Portal - Documents</title>
    <link rel="icon" type="image/png" href="/static/icons/cropped_logo.png" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='css/documents.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/icons.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300&display=swap"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="{{ url_for('static', filename='js/documents.js') }}"></script>
  </head>
  <body data-is-admin="{{ is_admin }}">
    <div class="container-fluid root-div">
      {% include 'sidebar.html' %}
      <div class="d-flex justify-content-end">
        <div class="card-wrapper">
          <div class="d-flex justify-content-between gap-lg-5">
            <h2 class="greeting" style="margin-top: 30px">
              {{ greeting_msg }}
            </h2>
            <div
              class="position-relative flex-shrink-0"
              style="margin-top: 30px"
            >
              <button
                id="upload-document-button"
                class="btn btn-primary end-0 top-0 d-none d-lg-block position-relative"
                type="button"
              >
                Upload Document
              </button>
              <div
                class="position-relative d-flex d-lg-none flex-column align-items-end"
              >
                <button
                  type="button"
                  class="z-3 d-block d-lg-none navbar-toggler top-0 end-0 pr-2 pt-2"
                  data-bs-toggle="collapse"
                  data-bs-target="#open-menu"
                  aria-expanded="false"
                  aria-controls="open-menu"
                  onclick="document.getElementById('open-menu').classList.toggle('d-none')"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    class="bi"
                    fill="currentColor"
                    viewBox="0 0 16 16"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M2.5 11.5A.5.5 0 0 1 3 11h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 7h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 3h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"
                    ></path>
                  </svg>
                </button>
                <div
                  id="open-menu"
                  class="d-none bg-light d-lg-none w-100 position-relative justify-content-end"
                >
                  <button
                    id="upload-document-button"
                    class="btn btn-primary end-0 top-0 position-relative"
                    type="button"
                  >
                    Upload Document
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="row d-flex mt-4 g-2">
            {% for document_type in document_types %}
            <div
              class="col-12 flex-shrink-0 col-sm-6 col-md-6 col-lg-6 col-xl-3"
            >
              <div class="card p-0 position-relative container-fluid rounded-0">
                <div class="py-2 px-0">
                  <div
                    class="card-body d-flex justify-content-between gap-3 align-items-start"
                  >
                    <div
                      id="text-container"
                      class="d-flex gap-2 align-items-center"
                      style="height: 40px"
                    >
                      <span
                        class="custom-icon-documents flex-shrink-0 d-none d-xl-block"
                      ></span>
                      <h6 id="card-title" class="mb-0">{{ document_type }}</h6>
                    </div>
                    <button
                      href="{{ url_for('get_documents', document_type=document_type) }}"
                      class="card-footer p-2 text-secondary rounded-0 btn btn-light border-0"
                    >
                      <small class="d-flex align-items-center gap-1">
                        <i class="fas fa-eye"></i>
                        <span>View</span>
                      </small>
                    </button>
                  </div>
                  <p class="card-text ms-3" style="font-size: 13px">
                    <span class="card-number"
                      >{{ document_counts[document_type] }}</span
                    >
                    Documents
                  </p>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          <div class="modal overflow-hidden" id="document-modal">
            <div class="d-flex justify-content-center align-items-center h-100">
              <div class="modal-content m-0" style="height: 570px">
                <span class="close text-end">&times;</span>
                <h3 class="modal-title fs-5">
                  Document Files - {{ document_type }}
                </h3>
                <div id="empty-message" class="d-none">
                  <p class="m-0">No documents found</p>
                </div>
                <ul id="documentList" class="document-list mt-3"></ul>
                <div class="d-flex justify-content-center w-100">
                  <p class="pagination m-0" id="pagination"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="error-notification" class="error-notification"></div>
    <div id="success-notification" class="success-notification"></div>
    <div id="action-modal" class="action-modal">
      <button id="delete-button">Delete Listing</button>
      <button id="edit-button">Edit Listing</button>
    </div>
    <div id="upload-document-modal" class="modal">
      <div id="error-notification-modal" class="error-notification-modal"></div>
      <div
        id="success-notification-modal"
        class="success-notification-modal"
      ></div>
      <div class="modal-content">
        <span class="close text-end">&times;</span>
        <form
          id="submit-document-form"
          class="modal-form"
          action="{{ url_for('submit_document') }}"
          method="POST"
        >
          <div class="modal-step active-step">
            <h2 class="modal-step-title">Upload New Document</h2>
            <div class="form-group">
              <label for="document-name">Document Name:</label>
              <input
                type="text"
                id="document-name"
                name="document-name"
                placeholder="File name"
                required
              />
            </div>
            <div class="form-group">
              <label for="document-type">Document Type:</label>
              <select id="document-type" name="document-type" required>
                <option value="Office Collaterals">Office Collaterals</option>
                <option value="Industrial Collaterals">
                  Industrial Collaterals
                </option>
                <option value="Investment Collaterals">
                  Investment Collaterals
                </option>
                <option value="Healthcare Collaterals">
                  Healthcare Collaterals
                </option>
                <option value="Retail Collaterals">Retail Collaterals</option>
                <option value="BOV Reports">BOV Reports</option>
                <option value="Quarterly Reports">Quarterly Reports</option>
                <option value="Key Marketing Pieces">
                  Key Marketing Pieces
                </option>
              </select>
            </div>
            <div class="form-group">
              <button id="upload-document-file" type="button">
                Upload Document File
              </button>
              <input
                id="document-file"
                type="file"
                style="display: none"
                accept=".pdf"
              />
              <input
                type="hidden"
                id="document-file-base64"
                name="document-file-base64"
              />
            </div>
            <div class="modal-navigation">
              <button
                id="submit-button"
                class="minimal-button submit-step upload-modal-btn-style"
                type="submit"
              >
                Upload Document
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <script>
      const documentList = document.getElementById("documentList");
      const emptyMessage = document.getElementById("empty-message");
      const pagination = document.getElementById("pagination");
      const itemsPerPage = 10;

      function displayDocuments(documents, pageNumber) {
        documentList.innerHTML = "";

        const startIndex = (pageNumber - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        for (let i = startIndex; i < endIndex && i < documents.length; i++) {
          const li = document.createElement("li");
          li.classList = "d-flex justify-content-between align-items-center";
          var downloadButton =
            '<a class="download-button" href="data:application/pdf;base64,' +
            documents[i].pdf_file_base64 +
            '" download="' +
            documents[i].document_name +
            '.pdf"><i class="fa fa-download"></i></a>';
          li.innerHTML = `
                  <div class="d-flex gap-2 align-items-center">
                    <i class="far fa-file-pdf text-dark" style="color: #1c92d2; font-size:22px;"></i>
                    <p class="mb-0">${documents[i].document_name}</p>
                  </div>
                  <span>${downloadButton}</span>`;
          documentList.appendChild(li);
        }
      }

      $(".card-footer").on("click", function (e) {
        e.preventDefault();
        var documentType = $(this)
          .closest(".card-body")
          .find("#text-container")
          .find("#card-title")
          .text();
        $.get(
          '{{ url_for("get_documents") }}',
          { document_type: documentType },
          function (data) {
            $("#document-modal .modal-title").text(
              "Documents Files - " + documentType
            );
            var modal = document.getElementById("document-modal");
            modal.style.display = "block";

            const documents = data;

            if (documents.length === 0) {
              pagination.innerHTML = "";
              documentList.innerHTML = "";
              emptyMessage.classList = "";
              emptyMessage.classList = "d-block mt-3";
            } else {
              emptyMessage.classList = "";
              emptyMessage.classList = "d-none";

              const totalPages = Math.ceil(documents.length / itemsPerPage);

              displayDocuments(documents, 1);

              function createPaginationButtons(totalPages, currentPage) {
                pagination.innerHTML = "";

                if (totalPages <= 7) {
                  for (let i = 1; i <= totalPages; i++) {
                    createPaginationButton(i, currentPage);
                  }
                } else {
                  for (let i = 1; i <= 2; i++) {
                    createPaginationButton(i, currentPage);
                  }

                  const ellipsisBefore = document.createElement("span");
                  ellipsisBefore.textContent = "...";
                  pagination.appendChild(ellipsisBefore);

                  for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                    if (i > 2 && i < totalPages - 1) {
                      createPaginationButton(i, currentPage);
                    }
                  }
                  const ellipsisAfter = document.createElement("span");
                  ellipsisAfter.textContent = "...";
                  pagination.appendChild(ellipsisAfter);

                  for (let i = totalPages - 1; i <= totalPages; i++) {
                    createPaginationButton(i, currentPage);
                  }
                }
              }

              createPaginationButtons(totalPages, 1);

              function createPaginationButton(pageNumber, currentPage) {
                console.log(pageNumber);
                if (pageNumber > 1) {
                  const button = document.createElement("button");
                  button.textContent = pageNumber;
                  button.classList = "page-item border-0";
                  if (pageNumber === currentPage) {
                    button.classList.add("active");
                  }
                  button.addEventListener("click", () => {
                    createPaginationButtons(totalPages, pageNumber);
                    displayDocuments(documents, pageNumber);
                  });
                  pagination.appendChild(button);
                }
              }
            }
          }
        );
      });
    </script>
  </body>
</html>
